<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>redres: Redress Your Mixed Model Assumptions • redres</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="redres: Redress Your Mixed Model Assumptions">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">redres</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0.9</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/redres-vignette.html">redres: Redress Your Mixed Model Assumptions</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/goodekat/redres.git">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>redres: Redress Your Mixed Model Assumptions</h1>
                        <h4 class="author">R Package Version 0.1.0.9</h4>
            
            <h4 class="date">2019-05-01</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/goodekat/redres.git/blob/master/vignettes/redres-vignette.Rmd"><code>vignettes/redres-vignette.Rmd</code></a></small>
      <div class="hidden name"><code>redres-vignette.Rmd</code></div>

    </div>

    
    
<div id="introducing-redres" class="section level1">
<h1 class="hasAnchor">
<a href="#introducing-redres" class="anchor"></a>Introducing redres</h1>
<p><strong>redres</strong> stands for <strong>r</strong>andom <strong>e</strong>ffect <strong>d</strong>iagnostic <strong>res</strong>iduals</p>
<p>This package is meant to be a supplemental package to <code>lme4</code>.</p>
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p><img align="right" width="150" height="175" src="figs/sticker.png"></p>
<p>The Merriam-Webster dictionary defines <a href="https://www.merriam-webster.com/dictionary/redress">redress</a> as “to set right”. When we assign a linear mixed model to data, we assume (1) independence of our observations, (2) a linear relationship between the response and the explanatory variables, (3) constant variance and (4) normality of the error term. By inspecting our residuals we can diagnose erronous assumptions and missing structure, allowing us to set right the more egregious misspecifications. No model is perfect, but our residuals are a first line of defense against an inaccurate model and consequently poor inference.</p>
</div>
<div id="package-structure" class="section level2">
<h2 class="hasAnchor">
<a href="#package-structure" class="anchor"></a>Package Structure</h2>
<p><code>redres</code> contains various functions that provide different ways to assess model assumptions for linear mixed models fit using <code>lmer</code>. For a user who wants to obtain the residual value for each observation in their data set, the function <code>redres</code> allows the user to input a model and specify one of six available residual types. The <a href="#types">available types</a> are described in detail below. Additionally the package provides several default plots to visually assess the fit of a given mixed model. Calling the plot functions and reading the output are described in the section on <a href="#plots">plotting</a>. Both, the residual functions and the plotting functions, generate static output within the user’s R session.</p>
<p>Alternatively, user can use the function <code>redres_app</code> that opens a Shiny app to interactively assess their model with package provided tools. Within the Shiny window, the user can view all the plots available in the <code>redres</code> package but with additional interactivity. Or the user can input two models into the app function for model selection.</p>
<p>A brief description of each function is listed below.</p>
<ul>
<li>
<a href="#redres">redres</a>: computes and returns residuals given a model and a specified residual type</li>
<li>
<a href="#plot_redres">plot_redres</a>: creates a plot of residuals versus fitted values for a given residual type</li>
<li>
<a href="#plot_resqq">plot_resqq</a>: creates a normal quantile plot for conditional residuals</li>
<li>
<a href="#plot_raneff">plot_raneff</a>: creates a normal quantile plot for the random effects</li>
<li>
<a href="#redres_app">redres_app</a>: opens an interactive Shiny app with</li>
</ul>
</div>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>The package can be installed from GitHub using devtools and then loaded in the normal way.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Installs redres from GitHub</span>
devtools<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/devtools/topics/reexports">install_github</a></span>(<span class="st">"goodekat/redres"</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Loads the package</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(redres)</code></pre></div>
</div>
<div id="linear-mixed-model-theory-and-assumptions" class="section level2">
<h2 class="hasAnchor">
<a href="#linear-mixed-model-theory-and-assumptions" class="anchor"></a>Linear Mixed Model Theory and Assumptions</h2>
<p>The linear mixed effects model can be written as <span class="math display">\[\textbf{Y}=\textbf{X}\boldsymbol{\beta}+\textbf{Z}\boldsymbol{\gamma}+\boldsymbol{\epsilon}\]</span> where</p>
<ul>
<li>
<span class="math inline">\(\textbf{Y}\)</span> is an <span class="math inline">\(n\times 1\)</span> vector of <span class="math inline">\(n\)</span> response variable observations,</li>
<li>
<span class="math inline">\(\textbf{X}\)</span> is an <span class="math inline">\(n\times p\)</span> matrix of <span class="math inline">\(p\)</span> explanatory variables with <span class="math inline">\(n\)</span> observations each,</li>
<li>
<span class="math inline">\(\boldsymbol{\beta}\)</span> is a <span class="math inline">\(p\times1\)</span> vector of unknown fixed effects parameters,</li>
<li>
<span class="math inline">\(\textbf{Z}\)</span> is an <span class="math inline">\(n\times q\)</span> matrix of <span class="math inline">\(q\)</span> random effect variables with <span class="math inline">\(n\)</span> observations each,</li>
<li>
<span class="math inline">\(\boldsymbol{\gamma}\)</span> is a <span class="math inline">\(q\times1\)</span> vector of unknown random effects, and</li>
<li>
<span class="math inline">\(\boldsymbol{\epsilon}\)</span> is an <span class="math inline">\(n\times1\)</span> vector of random errors.</li>
</ul>
<p>Under this set up, <span class="math display">\[E[\textbf{Y}]=\textbf{X}\boldsymbol{\beta} \ \ \ \mbox{ and } \ \ \ 
  Var[\textbf{Y}]=\textbf{ZGZ}'+\textbf{R}=\textbf{V}.\]</span></p>
<p>It is assumed that <span class="math display">\[ 
\begin{bmatrix} \boldsymbol{\gamma} \\ \boldsymbol{\epsilon} \end{bmatrix}
\sim N 
\begin{pmatrix} 
\begin{bmatrix} \boldsymbol{0} \\ \boldsymbol{0} \end{bmatrix},
\begin{bmatrix} \textbf{G} &amp; \boldsymbol{0} \\ \boldsymbol{0} &amp; \textbf{R}
\end{bmatrix}
\end{pmatrix}.
\]</span></p>
</div>
<div id="example-data" class="section level2">
<h2 class="hasAnchor">
<a href="#example-data" class="anchor"></a>Example Data</h2>
<p><code>redres</code> contains a dataset called <code>paprika</code>, which will be used to demonstrate the functions in this vignette. The data is from a study on paprika plants grown under small-scale farming conditions in southern Africa. The original paper on the study can be found <a href="https://link.springer.com/article/10.1007%2Fs10457-011-9415-2">here</a>. The study was conducted in 2007 and 2008 in Malawi using a split plot design with five replicates.</p>
<p>The researchers compared 4 fertilizer treatments and 6 plant varieties. The fertilizers were applied to the main plots, and the varieties were assigned to the subplots within a main plot. Within each replicate, 10 plants were randomly chosen from each fertilizer and variety treatment combination and observed over 20 weeks.</p>
<p>The dataset included in <code>redres</code> contains observations from week 4 of the data in 2008. It is stored as a tibble with 1070 rows and 5 variables. The variables are</p>
<ul>
<li>
<code>rep</code>: replicate number</li>
<li>
<code>treatment</code>: fertilizer treatment</li>
<li>
<code>variety</code>: plant variety</li>
<li>
<code>plant</code>: plant number (nested within rep, treatment, and variety)</li>
<li>
<code>height</code>: height of the plant (cm)</li>
</ul>
<p>The first six rows of the data and a histogram of the variable <code>height</code> are shown below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Prints the first 6 rows of the paprika data</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(paprika)
<span class="co">#&gt; # A tibble: 6 x 5</span>
<span class="co">#&gt;   rep   treatment variety plant height</span>
<span class="co">#&gt;   &lt;fct&gt; &lt;fct&gt;     &lt;fct&gt;   &lt;fct&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt; 1 1     T1        C1      1       23.5</span>
<span class="co">#&gt; 2 1     T1        C1      2       21.5</span>
<span class="co">#&gt; 3 1     T1        C1      3       31.2</span>
<span class="co">#&gt; 4 1     T1        C1      4       22.1</span>
<span class="co">#&gt; 5 1     T1        C1      5       31.5</span>
<span class="co">#&gt; 6 1     T1        C1      6       26</span>

<span class="co"># Creates a histogram of the height variable</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggplot2)
<span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(paprika, <span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> height)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/geom_histogram">geom_histogram</a></span>(<span class="dt">bins =</span> <span class="dv">35</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>()</code></pre></div>
<p><img src="redres-vignette_files/figure-html/unnamed-chunk-3-1.png" width="576" style="display: block; margin: auto;"></p>
<p>The code below fits a linear mixed effects model to the <code>paprika</code> dataset. This model will be used throughout this vignette. The terms included in the model are described below.</p>
<ul>
<li>
<code>rep</code> is included as a fixed effect in the model as a blocking variable.</li>
<li>
<code>treatment</code> is included as a fixed main effect</li>
<li>
<code>variety</code> is also included as a fixed main effect</li>
<li>
<code>treatment:variety</code> is included as an interaction term</li>
<li>
<code>rep:treatment</code> is included as a random effect to account for correlation within a main plot due to the split plot design</li>
<li>
<code>rep:treatment:variety</code> is also included as a random effect to account for dependency between the 10 plants within a rep and treatment by variety combination</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Loads the lme4 libraries</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(lme4)
<span class="co">#&gt; Loading required package: Matrix</span>
m &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/lmer">lmer</a></span>(height <span class="op">~</span><span class="st"> </span>rep <span class="op">+</span><span class="st"> </span>treatment<span class="op">*</span>variety <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span><span class="op">|</span>rep<span class="op">:</span>treatment) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span><span class="op">|</span>rep<span class="op">:</span>treatment<span class="op">:</span>variety), 
          <span class="dt">data =</span> paprika)</code></pre></div>
</div>
</div>
<div id="extracting-residuals" class="section level1">
<h1 class="hasAnchor">
<a href="#extracting-residuals" class="anchor"></a>Extracting Residuals</h1>
<p>One of the ways to utilize <code>redres</code> is to extract residuals from a model fit using <code>lmer</code>. This can be done using the function in the package named <code>redres</code> to compute residuals based on a specified type.</p>
<div id="types" class="section level2">
<h2 class="hasAnchor">
<a href="#types" class="anchor"></a>Residual Types</h2>
<p><code>redres</code> can compute both marginal and conditional residuals for the following types:</p>
<ul>
<li>raw</li>
<li>Pearson</li>
<li>studentized</li>
</ul>
<p>It is not necessary to consider all residual types when diagnosing a mixed model. Certain types are beneficial in different situations. For example, conditional residuals are useful for checking the effect of the random terms in the model as opposed to marginal residuals that do not account for the random effects, and studentized residuals are useful for checking constant variance with more complex variance structures. However, we have chosen to include all of these types so that the user may select which type (or types) is (are) useful for their situation. By default, <code>redres</code> returns raw conditional residuals since these are the most appropriate for a wide range of cases.</p>
<p>The formulas for how the residual types are computed in <code>redres</code> are listed below. Note that the manner in which some of the residual types are computed differ from the <code>resid</code> function in <code>lme4</code>. These changes were made so the names of the residual types more intuitive with the computations used.</p>
<div id="raw-residuals" class="section level3">
<h3 class="hasAnchor">
<a href="#raw-residuals" class="anchor"></a>Raw Residuals</h3>
<p>The raw residuals are computed as the observed response values minus the predicted response values where the marginal version does not account for the random effects while the conditional version does. These are computed as follows.</p>

<ul>
<li><p><strong>marginal</strong> raw residuals <span class="math display">\[r^m_i = Y_i-\textbf{x}'_i\widehat{\boldsymbol{\beta}}\]</span></p></li>
<li><p><strong>conditional</strong> raw residuals <span class="math display">\[r^c_i = Y_i-\textbf{x}'_i\boldsymbol{\widehat{\beta}}-\textbf{z}'_i\widehat{\boldsymbol{\gamma}}\]</span></p></li>
</ul>
</div>
<div id="pearson-residuals" class="section level3">
<h3 class="hasAnchor">
<a href="#pearson-residuals" class="anchor"></a>Pearson Residuals</h3>
<p>The Pearson residuals are computed as the raw residuals divided by the square root of the estimated variance of the response values. Both marginal and conditional versions are available as follows.</p>

<ul>
<li><p><strong>marginal</strong> Pearson residuals <span class="math display">\[r^{m,Pearson}_{i} = \frac{r^m_i}{\sqrt{\widehat{Var}[Y_i]}}\]</span></p></li>
<li><p><strong>conditional</strong> Pearson residuals <span class="math display">\[r^{c,Pearson}_{i} = \frac{r^c_i}{\sqrt{\widehat{Var}[Y_i|\boldsymbol{\gamma}]}}\]</span></p></li>
</ul>
</div>
<div id="studentized" class="section level3">
<h3 class="hasAnchor">
<a href="#studentized" class="anchor"></a>Studentized</h3>
<p>The studentized residuals are computed as the raw residuals divided by the square root of the estimated variance of the raw residuals. Again, both marginal and conditional versions are available.</p>
<ul>
<li><p><strong>marginal</strong> Pearson residuals <span class="math display">\[r_i^{m,std}=\frac{r_i^m}{\sqrt{\widehat{Var}[r_i^m]}}\]</span></p></li>
<li><p><strong>conditional</strong> studentized residuals <span class="math display">\[r_i^{c,std}=\frac{r_i^c}{\sqrt{\widehat{Var}[r_i^c]}}\]</span></p></li>
</ul>
<p>Note that <span class="math display">\[\widehat{Var}[\textbf{r}^m]=\widehat{\textbf{V}}-\textbf{Q} \ \ \ \mbox{ and } \ \ \ \widehat{Var}[\textbf{r}^c]=\textbf{K}\left(\widehat{\textbf{V}}-\textbf{Q}\right)\textbf{K}'.\]</span> The values of <span class="math inline">\(\textbf{Q}\)</span> and <span class="math inline">\(\textbf{K}\)</span> are defined as follows by by Gregoire, Schabenberger, and Barrett (1995).</p>
<p><span class="math display">\[\textbf{Q}=\textbf{X}(\textbf{X}'\widehat{\textbf{V}}^{-1}\textbf{X})^{-}\textbf{X}' \ \ \ \mbox{ and } \ \ \ \textbf{K}=\textbf{I}-\textbf{Z}\widehat{\textbf{G}}\textbf{Z}'\widehat{\textbf{V}}^{-1}\]</span></p>
</div>
</div>
<div id="usage" class="section level2">
<h2 class="hasAnchor">
<a href="#usage" class="anchor"></a>Usage</h2>
<p>The function <code>redres</code> can compute the residuals types defined in the previous section for models fit using <code>lmer</code>.</p>
<p><strong>Inputs</strong></p>
<ul>
<li>
<code>model</code>: A model fit using <code>lmer</code> for which the residuals will be computed.</li>
<li>
<code>type</code>: A character string identifying the type of residual that will be computed. By default, the raw conditional residuals are returned. The following are the options available for type.
<ul>
<li>
<code>"pearson_cond"</code>: Pearson conditional residuals</li>
<li>
<code>"pearson_mar"</code>: Pearson marginal residuals</li>
<li>
<code>"raw_cond"</code>: raw conditional residuals (default)</li>
<li>
<code>"raw_mar"</code>: raw marginal residuals</li>
<li>
<code>"std_cond"</code>: studentized conditional residuals</li>
<li>
<code>"std_mar"</code>: studentized marginal residuals</li>
</ul>
</li>
</ul>
<p>See the section on <a href="#types">residual types</a> for details on how the residuals are computed and their purpose.</p>
<p><strong>Output</strong></p>
<ul>
<li>
<code>redres</code> returns a vector of residuals according to the type specified in the order that the data observations are input into <code>lmer</code>.</li>
</ul>
<p><strong>Functionality</strong></p>
<p>The code below demonstrates the use of <code>redres</code> to compute several types of residuals from the model <code>m</code>. These residuals are put into a dataframe and joined with the <code>paprika</code> data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Computes the default residuals (raw conditional)</span>
raw_cond &lt;-<span class="st"> </span><span class="kw"><a href="../reference/redres.html">redres</a></span>(m)

<span class="co"># Computes the Pearson marginal residuals</span>
pearson_mar &lt;-<span class="st"> </span><span class="kw"><a href="../reference/redres.html">redres</a></span>(m, <span class="dt">type =</span> <span class="st">"pearson_mar"</span>)

<span class="co"># Computes the studentized conditional residuals</span>
std_cond &lt;-<span class="st"> </span><span class="kw"><a href="../reference/redres.html">redres</a></span>(m, <span class="dt">type =</span> <span class="st">"std_cond"</span>)

<span class="co"># Joins the residuals to the paprika data</span>
paprika_plus &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(paprika, raw_cond, pearson_mar, std_cond)

<span class="co"># Prints the head of the dataframe</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(paprika_plus)
<span class="co">#&gt;   rep treatment variety plant height   raw_cond pearson_mar   std_cond</span>
<span class="co">#&gt; 1   1        T1      C1     1   23.5 -0.8171447  0.28484517 -0.1476290</span>
<span class="co">#&gt; 2   1        T1      C1     2   21.5 -2.8171447  0.04144796 -0.5089579</span>
<span class="co">#&gt; 3   1        T1      C1     3   31.2  6.8828553  1.22192446  1.2434874</span>
<span class="co">#&gt; 4   1        T1      C1     4   22.1 -2.2171447  0.11446712 -0.4005593</span>
<span class="co">#&gt; 5   1        T1      C1     5   31.5  7.1828553  1.25843404  1.2976867</span>
<span class="co">#&gt; 6   1        T1      C1     6   26.0  1.6828553  0.58909169  0.3040322</span></code></pre></div>
<p>The user can then use these residuals as desired. For example, the user could make their own plots or perform tests on the residuals. The code below performs a Shapiro-Wilk test for normality on the raw conditional residuals and creates histograms of the three residual types.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Performs a test for normality on the raw conditional residuals</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/shapiro.test">shapiro.test</a></span>(paprika_plus<span class="op">$</span>raw_cond)
<span class="co">#&gt; </span>
<span class="co">#&gt;  Shapiro-Wilk normality test</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; data:  paprika_plus$raw_cond</span>
<span class="co">#&gt; W = 0.99184, p-value = 1.214e-05</span>

<span class="co"># Loads helpful libraries </span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidyr)

<span class="co"># Creates histograms of the residual types</span>
paprika_plus <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span>(<span class="dt">key =</span> <span class="st">"type"</span>, <span class="dt">value =</span> <span class="st">"residual"</span>, <span class="dv">6</span><span class="op">:</span><span class="dv">8</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> residual)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/geom_histogram">geom_histogram</a></span>(<span class="dt">bins =</span> <span class="dv">30</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/facet_grid">facet_grid</a></span>(. <span class="op">~</span><span class="st"> </span>type, <span class="dt">scales =</span> <span class="st">"free"</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>()</code></pre></div>
<p><img src="redres-vignette_files/figure-html/unnamed-chunk-6-1.png" width="768" style="display: block; margin: auto;"></p>
</div>
</div>
<div id="plots" class="section level1">
<h1 class="hasAnchor">
<a href="#plots" class="anchor"></a>Plotting Residuals</h1>
<p>The package includes three <code>plot</code> functions that allow the user to visually assess the general assumptions of a linear mixed model (using <code>ggplot2</code> graphics).</p>
<ul>
<li>
<a href="#plot_redres"><code>plot_redres</code></a>: creates a plot of the residuals versus the fitted values or model variables</li>
<li>
<a href="#plot_resqq"><code>plot_resqq</code></a>: creates a normal quantile plot of the residuals</li>
<li>
<a href="#plot_ranef"><code>plot_ranef</code></a>: creates a normal quantile plot of the random effects</li>
</ul>
<div id="plot-types" class="section level2">
<h2 class="hasAnchor">
<a href="#plot-types" class="anchor"></a>Plot Types</h2>
<p><code>redres</code> makes use of two types of plots (residual and quantile plots) to assess the model assumptions. How these plots are created and used are described below.</p>
<div id="residual-plots" class="section level3">
<h3 class="hasAnchor">
<a href="#residual-plots" class="anchor"></a>Residual Plots</h3>
<p>Plots of the residuals by either the fitted values or explanatory variables (covariates) are used to verify linearity and constant variance. If no curvature or additional linear trends are identified in the residual plot, we say that the linear form is a reasonable assumption. To assess our variance assumptions, we are looking for constant variance. Here using a scaled residual, either the studentized or Pearson, is necessary to account for additional variance structures modeled outside of the error term. We want the vertical spread of the residuals to be approximately the same for all x-axis values.</p>
<p>Residual plots can be called using the <code>plot_redres</code> function. The user has the ability to specify either fitted values or a explanatory variable from the model. Additionally any of the six <a href="#types">types of residuals</a> can be used in the plot.</p>
</div>
<div id="quantile-plots" class="section level3">
<h3 class="hasAnchor">
<a href="#quantile-plots" class="anchor"></a>Quantile plots</h3>
<p>Quantile plots are used to verify visually if data follows are particular distribution. Data points are plotted along the quantiles of the assumed distributed. The data is expected to follow an approximately straight line, at least along the middle quantiles. The points are assessed for any extreme curvation that would indicate a departure from the assumed distribution. Typically curvature at the extreme ends of the quantiles (around 0 and 1) are ignored as data is sparse here and distributions behave more erratically at the boundaries of the parameter space. We have added confidence bands to guide the user.</p>
<p>The function <code>plot_ranef</code> plots each random effect vector along the normal quantiles. From the assumptions of the linear mixed model, each random effect specified is assumed to follow a normal distribution. Therefore, these plots can be used to assess if this assumption is met. Note that the number of plots generated by this function will vary for each model, with the number of plots being the number of random effects.</p>
<p>From above we can see that the error term is assumed to follow a normal distribution as well. The function <code>plot_resqq</code> provides a normal quantile plot with confidence bands for the raw conditional residuals. See <a href="#types">above</a> for a description of the raw conditional residuals (type = <code>raw_cond</code>).</p>
</div>
</div>
<div id="usage-1" class="section level2">
<h2 class="hasAnchor">
<a href="#usage-1" class="anchor"></a>Usage</h2>
<div id="plot_redres" class="section level3">
<h3 class="hasAnchor">
<a href="#plot_redres" class="anchor"></a>plot_redres</h3>
<p>The function <code>plot_redres</code> is included in the package to allow for the easy creation of a residual plot using <code>ggplot2</code> for a linear mixed model fit using <code>lmer</code>. <code>plot_redres</code> allows the user to specify any residual type to be plotted on the y-axis including those not provided by <code>lme4</code>.</p>
<p><strong>Inputs</strong></p>
<ul>
<li>
<code>model</code>: A model fit using <code>lmer</code> for which the residuals will be computed.</li>
<li>
<code>type</code>: A character string identifying the type of residual that will be computed. The same options available with <a href="#redres"><code>redres</code></a> are available for <code>plot_redres</code>. By default, the conditional raw residuals are plotted.</li>
<li>
<code>xvar</code>: A character string identifying the variable to be plotted at the x-axis. By default, the fitted values are plotted on the x-axis.</li>
</ul>
<p><strong>Output</strong></p>
<ul>
<li>A <code>ggplot2</code> object of a scatterplot of the model residuals of the type specified versus the specified x-variable.</li>
</ul>
<p><strong>Functionality</strong></p>
<p>The code below shows how to create the most basic plot using <code>plot_redres</code>. By inputting the model <code>m</code>, a plot of the conditional raw residuals versus the fitted values is returned.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Creates the default residual plot</span>
<span class="kw"><a href="../reference/plot_redres.html">plot_redres</a></span>(m)</code></pre></div>
<p><img src="redres-vignette_files/figure-html/unnamed-chunk-7-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Here we see that while there does not appear to be any linear trend in our data, there is the classic “fan” shape indicating inconstant variance. As the fitted values increase, the vertical spread of the residuals also decreasing. The lack of any other form in the residuals suggests that the linear form assumption is reasonable. We do want to try alternative model formulations in order to address the inconstant variance and then we would need to reassess linearity for the new model.</p>
<p>Perhaps additionally we are interested in the marginal effect of variety, so we want to see the residuals by variety of paprika planted. The plot below suggests that variety does not provide us with extra structure for modeling height.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Residual plot of raw conditional residuals against variety fixed effect.</span>
<span class="kw"><a href="../reference/plot_redres.html">plot_redres</a></span>(m, <span class="dt">xvar =</span> <span class="st">"variety"</span>)</code></pre></div>
<p><img src="redres-vignette_files/figure-html/unnamed-chunk-8-1.png" width="576" style="display: block; margin: auto;"></p>
<p>The type of residuals can be changed using the <code>type</code> option as shown in the code below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Creates the residual plot with studentized marginal residuals</span>
<span class="kw"><a href="../reference/plot_redres.html">plot_redres</a></span>(m, <span class="dt">type =</span> <span class="st">"std_mar"</span>)</code></pre></div>
<p><img src="redres-vignette_files/figure-html/unnamed-chunk-9-1.png" width="576" style="display: block; margin: auto;"></p>
<p>We notice in the marginal residuals an upward trend as the fitted values increase. From our experimental design we suspect that this trend might be related to the replications. When we plot the residuals now by replication ID we see the same upward trend as replication ID increases. If we plot by treatment we do not see this trend.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plot_redres.html">plot_redres</a></span>(m, <span class="dt">type =</span> <span class="st">"std_mar"</span>, <span class="dt">xvar =</span> <span class="st">"rep"</span>)</code></pre></div>
<p><img src="redres-vignette_files/figure-html/unnamed-chunk-10-1.png" width="576" style="display: block; margin: auto;"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plot_redres.html">plot_redres</a></span>(m, <span class="dt">type =</span> <span class="st">"std_mar"</span>, <span class="dt">xvar =</span> <span class="st">"treatment"</span>)</code></pre></div>
<p><img src="redres-vignette_files/figure-html/unnamed-chunk-10-2.png" width="576" style="display: block; margin: auto;"></p>
<p>All plots created using the <code>redres</code> package are formatted to use <code>theme_bw</code> from <code>ggplot2</code>. However, since <code>plot_redres</code> returns a ggplot object, it is possible to use functions provided by <code>ggplot2</code> to adjust the formatting of the plot.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Applies ggplot2 formatting functions to the output from plot_resid</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggplot2)
<span class="kw"><a href="../reference/plot_redres.html">plot_redres</a></span>(m, <span class="dt">type =</span> <span class="st">"pearson_cond"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_classic</a></span>() <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/labs">labs</a></span>(<span class="dt">title =</span> <span class="st">"Residual Plot"</span>)</code></pre></div>
<p><img src="redres-vignette_files/figure-html/unnamed-chunk-11-1.png" width="576" style="display: block; margin: auto;"></p>
</div>
<div id="plot_resqq" class="section level3">
<h3 class="hasAnchor">
<a href="#plot_resqq" class="anchor"></a>plot_resqq</h3>
<p><strong>Inputs</strong></p>
<ul>
<li>
<code>model</code>: A model fit using <code>lmer</code>.</li>
</ul>
<p><strong>Output</strong></p>
<ul>
<li>A <code>ggplot2</code> object of a normal quantile plot for the raw conditional residuals with normal theory 95% confidence bands.</li>
</ul>
<p><strong>Functionality</strong></p>
<p>We can check our normal assumption on the error terms for our paprika model using <code>plot_resqq</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plot_resqq.html">plot_resqq</a></span>(m)</code></pre></div>
<p><img src="redres-vignette_files/figure-html/unnamed-chunk-12-1.png" width="576" style="display: block; margin: auto;"></p>
<p>From the quantile plot, we see that along the middle of the distribution (around zero) the points fall in roughly a straight line with no S-shaped curvature. Even though there are some points falling outside the confidence bands at the tails of the distribution - the extreme values of -20 and 20 - we still would consider the normal assumption reasonable. It is not uncommon to see outliers near the tails where the probability decreases.</p>
</div>
<div id="plot_ranef" class="section level3">
<h3 class="hasAnchor">
<a href="#plot_ranef" class="anchor"></a>plot_ranef</h3>
<p><strong>Inputs</strong></p>
<ul>
<li>
<code>model</code>: A model fit using <code>lmer</code>.</li>
</ul>
<p><strong>Output</strong></p>
<ul>
<li>A grid of normal quantile plots with normal theory 95% confidence bands in the <code>ggplot2</code> framework for all random terms in the model.</li>
</ul>
<p><strong>Functionality</strong></p>
<p>We now check our normal assumption on the random effects for our paprika model using <code>plot_ranef</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plot_ranef.html">plot_ranef</a></span>(m)</code></pre></div>
<p><img src="redres-vignette_files/figure-html/unnamed-chunk-13-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Our model <code>m</code> had two random effects - a random intercept for <span class="math inline">\(rep \times treatment \times variety\)</span> and another random intercept for <span class="math inline">\(rep \times treatment\)</span>. Therefore, we get a grid of two plots where the random effect term is identified along the y-axis. We see that the points fall along the straight reference line and well-within the confidence bands. We can conclude that the normal assumption for both random effect terms is not violated.</p>
</div>
</div>
</div>
<div id="interacting-with-residuals" class="section level1">
<h1 class="hasAnchor">
<a href="#interacting-with-residuals" class="anchor"></a>Interacting with Residuals</h1>
<div id="redres_app" class="section level2">
<h2 class="hasAnchor">
<a href="#redres_app" class="anchor"></a>Shiny App</h2>
<p>The function <code>redres_app</code> opens a Shiny app that generates output for the plotting functions <code>plot_redres</code>, <code>plot_resqq</code> and <code>plot_ranef</code>. There are two main tabs in the app, one for the residual plot and another for the quantile plots. The residual plot gives the user a choice of all <a href="#types">residual types</a> and x-axis variables. The available x-axis variables are extracted from the input model.</p>
<p>When a list of two models is input into the function <code>redres_app</code>, the app shows a side-by-side comparison of the plots. The user then is able to compare visually the two linear mixed models and conduct model selection.</p>
</div>
<div id="usage-2" class="section level2">
<h2 class="hasAnchor">
<a href="#usage-2" class="anchor"></a>Usage</h2>
<div id="plot_app" class="section level3">
<h3 class="hasAnchor">
<a href="#plot_app" class="anchor"></a>redres_app</h3>
<p><strong>Inputs</strong></p>
<ul>
<li>
<code>model</code>: A model (or two models wrapped in a list) fit using <code>lmer</code>.</li>
</ul>
<p><strong>Output</strong></p>
<ul>
<li>A <code>shiny</code> app.</li>
</ul>
<p><strong>Functionality</strong></p>
<ul>
<li>One fitted model:</li>
</ul>
<p>The code below shows how to create a <code>shiny</code> app. By inputting the model argument as <code>m</code>, a <code>shiny</code> app window is returned.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Creates a shiny app with only model</span>
<span class="kw"><a href="../reference/redres_app.html">redres_app</a></span>(m)</code></pre></div>
<p>Two selection widgets shown in the <code>Residual Plot</code> tab are for choosing <a href="#types">residual types</a></p>
<p><img align="center" width="600" src="figs/resid_type.png"></p>
<p>and x-axis variables.</p>
<p><img align="center" width="600" src="figs/xvar.png"></p>
<p>The <code>Quantile Plots</code> tab shown below contains a random effects normal quantile plot</p>
<p><img align="center" width="600" src="figs/rand_eff_qq.png"></p>
<p>and error term normal quantile plot.</p>
<p><img align="center" width="600" src="figs/error_qq.png"></p>
<ul>
<li>Two fitted models:</li>
</ul>
<p>Input the model argument as <code>cmbd</code> which contains a list of two models to do model comparison using <code>shiny</code> app.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Fit a different linear mixed model with paprika data</span>
m &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/lmer">lmer</a></span>(height <span class="op">~</span><span class="st"> </span>rep <span class="op">+</span><span class="st"> </span>treatment<span class="op">*</span>variety <span class="op">+</span><span class="st"> </span>
<span class="st">            </span>(<span class="dv">1</span><span class="op">|</span>rep<span class="op">:</span>treatment<span class="op">:</span>variety), 
          <span class="dt">data =</span> paprika)

<span class="co"># Fit a linear mixed model after log transform the response</span>
m_log &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/lmer">lmer</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(height) <span class="op">~</span><span class="st"> </span>rep <span class="op">+</span><span class="st"> </span>treatment<span class="op">*</span>variety <span class="op">+</span><span class="st"> </span>
<span class="st">               </span>(<span class="dv">1</span><span class="op">|</span>rep<span class="op">:</span>treatment<span class="op">:</span>variety), 
             <span class="dt">data =</span> paprika)

<span class="co"># Combine the two models</span>
cmbd &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(m, m_log)

<span class="co"># Creates a shiny app with two models</span>
<span class="kw"><a href="../reference/redres_app.html">redres_app</a></span>(cmbd)</code></pre></div>
<p>The plots are shown side by side if there are two inputted models. For variables on the x-axis, different model can have different selected variables.</p>
<p><img align="center" width="600" src="figs/resid_two_model.png"></p>
<p>And the following show one of the quantile plots:</p>
<p><img align="center" width="600" src="figs/error_qq_two_mod.png"></p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#introducing-redres">Introducing redres</a><ul class="nav nav-pills nav-stacked">
<li><a href="#overview">Overview</a></li>
      <li><a href="#package-structure">Package Structure</a></li>
      <li><a href="#installation">Installation</a></li>
      <li><a href="#linear-mixed-model-theory-and-assumptions">Linear Mixed Model Theory and Assumptions</a></li>
      <li><a href="#example-data">Example Data</a></li>
      </ul>
</li>
      <li>
<a href="#extracting-residuals">Extracting Residuals</a><ul class="nav nav-pills nav-stacked">
<li><a href="#types">Residual Types</a></li>
      <li><a href="#usage">Usage</a></li>
      </ul>
</li>
      <li>
<a href="#plots">Plotting Residuals</a><ul class="nav nav-pills nav-stacked">
<li><a href="#plot-types">Plot Types</a></li>
      <li><a href="#usage-1">Usage</a></li>
      </ul>
</li>
      <li>
<a href="#interacting-with-residuals">Interacting with Residuals</a><ul class="nav nav-pills nav-stacked">
<li><a href="#redres_app">Shiny App</a></li>
      <li><a href="#usage-2">Usage</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Katherine Goode.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
