---
title: "redres: Redress Your Mixed Model Assumptions"
author: "R Package Version `r packageVersion('redres')`"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = "center",
  fig.width = 5
)
```

# Introduction

The Merriam-Webster dictionary defines [redress](https://www.merriam-webster.com/dictionary/redress) as "to set right".

The package can be installed from GitHub using devtools and then loaded in the normal way.

```{r eval = FALSE}
# Installs redres from GitHub
devtools::install_github("goodekat/redres")
```

```{r}
# Loads the package
library(redres)
```

# Package Functions 

`redres` contains various functions that provide different ways to assess model assumptions for linear mixed models fit using `lmer`. The function range from returning a vector of residuals to be used by the user as desired to opening a Shiny app that allows the user to interactively assess the model with package provided tools. A brief description of each function is listed below.

- [redres](#redres): computes and returns residuals given a model and a specified residual type
- [plot_redres](#plot_redres): creates a plot of residuals versus fitted values for a given residual type
- [plot_resqq](#plot_resqq): creates a normal quantile plot for conditional residuals
- [plot_raneff](#plot_raneff): creates a normal quantile plot for the random effects
- [redres_app](#redres_app): opens an interactive Shiny app with 

Each of these functions has a subsection below that describes in further detail what the function does, how to use it, and how to interpret the output. The functions will be demenstrated using the data `sleepstudy` from the `lme4` package and the linear mixed effects models fit in the code below called `fm1`.

```{r}
# Loads the lme4 libraries
library(lme4)

# Prints the first 6 rows of the sleepstudy data
head(sleepstudy)

# Fits a linear mixed effects model to the sleepstudy data
(m <- lmer(Reaction ~ Days + (Days|Subject), sleepstudy))
```

## redres {#redres}

The function `redres` app can be used to compute a handful of residual types for models fit using `lmer` including some not available through `lme4`.

**Inputs**

- `model`: A model fit using `lmer` for which the residuals will be computed.
- `type`:	A character string identifying the type of residual that will be computed. By default, the raw conditional residuals are returned. The following are the options available for type.
      - `"genres"`: generalized residuals
      - `"pearson_cond"`: Pearson conditional residuals
      - `"pearson_mar"`: Pearson marginal residuals
      - `"raw_cond"`: raw conditional residuals (default)
      - `"raw_mar"`: raw marginal residuals
      - `"std_cond"`: studentized conditional residuals
      - `"std_mar"`: studentized marginal residuals  
      
See the section on [residual types](#types) for details on how the residuals are computed and their purpose.

**Output**

- `redres` returns a vector of residuals according to the type specified in the order that the data observations are input into `lmer`.

**Functionality** 

The code below demonstrates the use of `redres` to compute several types of residuals from the model `m`. These residuals are put into a dataframe and joined with the `sleepstudy` data. The user can then use these residuals as desired.

```{r}
# Computes the default residuals (raw conditional)
rcr <- redres(m)

# Computes the Pearson marginal residuals
pmr <- redres(m, type = "pearson_mar")

# Computes the studentized conditional residuals
scr <- redres(m, type = "std_cond")

# Joins the residuals to the sleepstudy data
sleepstudy_plus <- cbind(sleepstudy, rcr, pmr, scr)
head(sleepstudy_plus)
```

## plot_redres {#plot_redres}

The function `plot_redres` is included in the package to allow for the easy creation of a residual plot using `ggplot2` for a linear mixed model fit using `lmer`. `plot_redres` allows the user to specify any residual type to be plotted on the y-axis including those not provided by `lme4`.

**Inputs**

- `model`: A model fit using `lmer` for which the residuals will be computed.
- `type`:	A character string identifying the type of residual that will be computed. The same options available with [`redres`](#redres) are available for `plot_redres` except for `genres` (since this type of plot does not make sense for `genres) By default, the conditional raw residuals are plotted.

**Output**

- A `ggplot2` object of a scatterplot of the model residuals of the type specified versus the fitted values is created.

**Functionality**

The code below shows how to create the most basic plot using `plot_redres`. By inputing the model `m`, a plot of the conditional raw residuals versus the fitted values is returned. 

```{r}
# Creates the default residual plot
plot_redres(m)
```

The type of residuals can be changed using the `type` option as shown in the code below.

```{r}
# Creates the residual plot with studentized marginal residuals
plot_redres(m, type = "std_mar")
```

All plots created using the `redres` package are formatted to use `theme_bw` from `ggplot2`. However, since `plot_redres` returns a ggplot object, it is possible to use functions provided by `ggplot2` adjust the formatting of the plot.

```{r}
# Applies ggplot2 formatting functions to the output from plot_resid
library(ggplot2)
plot_redres(m, type = "pearson_cond") +
  theme_classic() +
  labs(title = "Residual Plot")
```

## plot_resqq {#plot_resqq}

## plot_ranef {#plot_ranef}

### Quantile plots

Quantile plots are used to verify visually if data follows are particular distribution. Data points are plotted along the quantiles of the assumed distributed. The data is expected to follow an approximately straight line, at least along the middle quantiles. The points are assessed for any extreme curvation that would indicate a departure from the assumed distribution. Typically curvature at the extreme ends of the quantiles (around 0 and 1) are ignored as data is sparse here and distributions behave more erratically at the boundaries of the parameter space. We have added confidence bands to guide the user.  

The function `plot_ranef` plots each random effect vector along the normal quantiles. From the assumptions of the linear mixed model, each random effect specified - along with the error term - is assumed to follow a normal distribution. Therefore, these plots can be used to assess if this assumption is met. Note that the number of plots generated by this function will vary for each model, with the number of plots being the number of random effects.  

## redres_app {#redres_app}

# Residual Types {#types}

Section on how to compute the different residual types and when to use them...

The linear mixed effects model can be written as
  $$\textbf{Y}=\textbf{X}\boldsymbol{\beta}+\textbf{Z}\boldsymbol{\gamma}+\boldsymbol{\epsilon}$$
where

- $\textbf{Y}$ is an $n\times 1$ vector of $n$ response variable observations,
- $\textbf{X}$ is an $n\times p$ matrix of $p$ explanatory variables with $n$ observations each,
- $\boldsymbol{\beta}$ is a $p\times1$ vector of unknown fixed effects parameters,
- $\textbf{Z}$ is an $n\times q$ matrix of $q$ random effect variables with $n$ observations each,
- $\boldsymbol{\gamma}$ is a $q\times1$ vector of unknown random effects, and
- $\boldsymbol{\epsilon}$ is an $n\times1$ vector of random errors.

By assumption, it is the case that...
$$ 
\begin{bmatrix} \boldsymbol{\gamma} \\ \boldsymbol{\epsilon} \end{bmatrix}
  \sim N 
    \begin{pmatrix} 
      \begin{bmatrix} \boldsymbol{0} \\ \boldsymbol{0} \end{bmatrix},
      \begin{bmatrix} \textbf{G} & \boldsymbol{0} \\ \boldsymbol{0} & \textbf{R} \end{bmatrix}
    \end{pmatrix}
$$

## Raw

- marginal: 
  $$\textbf{r}^m_i = Y_i-\textbf{x}'_i\hat{\boldsymbol{\beta}}$$
- conditional:
  $$\textbf{r}^c_i = Y_i-\textbf{x}'_i\hat{\boldsymbol{\beta}}-\textbf{z}'_i\hat{\boldsymbol{\gamma}}$$

## Pearson

- marginal: 
  $$\textbf{r}^{m,pearson}_{i} = \frac{r^m_i}{\sqrt{\hat{Var[Y_i]}}}$$
- conditional: 
  $$\textbf{r}^{c,pearson}_{i} = \frac{r^m_i}{\sqrt{\hat{Var[Y_i|\boldsymbol{\gamma}]}}}$$

## Studentized

- marginal:
- conditional:

# Application





